<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TaskMaster</title>
    <style>
        /* ... (keep all the existing styles from previous dashboard.html) ... */
        /* Add this to the styles section */
        .clickable {
            cursor: pointer;
        }
        .category-card {
            cursor: pointer;
        }
        .submit-btn {
            cursor: pointer;
        }
        .sidebar-menu li {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <a href="index.html" class="logo">TaskMaster</a>
        <div class="user-menu">
            <div class="balance" id="balance">$0.00</div>
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li class="active" onclick="showSection('dashboard')">
                    <i>üìä</i> Dashboard
                </li>
                <li onclick="showSection('tasks')">
                    <i>üìã</i> Available Tasks
                </li>
                <li onclick="showSection('submissions')">
                    <i>üìù</i> My Submissions
                </li>
                <li onclick="showSection('withdrawals')">
                    <i>üí∞</i> Withdrawals
                </li>
                <li onclick="showSection('feedback')">
                    <i>üí¨</i> Feedback
                </li>
                <li onclick="showSection('profile')">
                    <i>üë§</i> Profile
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="welcome-banner">
                    <h1>Welcome back, <span id="welcomeName">User</span>!</h1>
                    <p>Complete tasks and earn money today.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Total Earnings</h3>
                            <div class="stat-number" id="totalEarnings">$0</div>
                        </div>
                        <div class="stat-icon">üí∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Available Balance</h3>
                            <div class="stat-number" id="availableBalance">$0</div>
                        </div>
                        <div class="stat-icon">üíµ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Tasks Completed</h3>
                            <div class="stat-number" id="tasksCompleted">0</div>
                        </div>
                        <div class="stat-icon">‚úÖ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Pending Approval</h3>
                            <div class="stat-number" id="pendingTasks">0</div>
                        </div>
                        <div class="stat-icon">‚è≥</div>
                    </div>
                </div>

                <h2 class="section-title">Task Categories</h2>
                <div class="categories-grid" id="categoriesList">
                    <!-- Categories will be loaded here -->
                </div>

                <h2 class="section-title">Recent Available Tasks</h2>
                <div class="tasks-grid" id="recentTasks">
                    <!-- Recent tasks will be loaded here -->
                </div>
            </div>

            <!-- Tasks Section -->
            <div id="tasksSection" style="display: none;">
                <h2 class="section-title">Available Tasks</h2>
                
                <div class="filters" style="margin-bottom: 20px;">
                    <select id="categoryFilter" onchange="filterTasks()" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="sortFilter" onchange="filterTasks()" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-left: 10px;">
                        <option value="newest">Newest First</option>
                        <option value="price-high">Highest Price</option>
                        <option value="price-low">Lowest Price</option>
                    </select>
                </div>

                <div class="tasks-grid" id="allTasks">
                    <!-- All tasks will be loaded here -->
                </div>
            </div>

            <!-- Submissions Section -->
            <div id="submissionsSection" style="display: none;">
                <h2 class="section-title">My Submissions</h2>
                
                <div class="submissions-table">
                    <div class="table-header">
                        <div>Task</div>
                        <div>Submitted</div>
                        <div>Amount</div>
                        <div>Status</div>
                        <div>Action</div>
                    </div>
                    <div id="submissionsList">
                        <!-- Submissions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Withdrawals Section -->
            <div id="withdrawalsSection" style="display: none;">
                <h2 class="section-title">Withdrawals</h2>
                
                <div class="withdrawals-container">
                    <div class="withdrawal-form">
                        <h3>Request Withdrawal</h3>
                        <div class="form-group">
                            <label>Amount ($)</label>
                            <input type="number" id="withdrawAmount" min="10" step="0.01" placeholder="Enter amount">
                            <small style="color: #666;">Minimum withdrawal: $10</small>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod">
                                <option value="paypal">PayPal</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="crypto">Cryptocurrency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Account Details</label>
                            <textarea id="accountDetails" placeholder="Enter your account details for payment" rows="3"></textarea>
                        </div>
                        <button class="submit-task-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
                    </div>

                    <div class="withdrawal-history">
                        <h3>Withdrawal History</h3>
                        <div id="withdrawalHistory">
                            <!-- Withdrawal history will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedbackSection" style="display: none;">
                <h2 class="section-title">Feedback & Reviews</h2>
                
                <div class="feedback-section" id="feedbackList">
                    <!-- Feedback will be loaded here -->
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" style="display: none;">
                <h2 class="section-title">Profile Settings</h2>
                
                <div style="background: white; padding: 30px; border-radius: 10px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" value="">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="profileEmail" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="profilePhone" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label>PayPal Email</label>
                        <input type="email" id="profilePaypal" placeholder="Enter your PayPal email">
                    </div>
                    <div class="form-group">
                        <label>Bank Account Details</label>
                        <textarea id="profileBank" placeholder="Enter your bank account details" rows="3"></textarea>
                    </div>
                    <button class="submit-task-btn" onclick="updateProfile()">Update Profile</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Task Modal -->
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit Task</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="taskDetails"></div>
                
                <div class="form-group">
                    <label>Your Work</label>
                    <textarea id="submissionWork" placeholder="Describe your work or provide links/files" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="submissionNotes" placeholder="Any additional information for the admin" rows="3"></textarea>
                </div>
                
                <button class="submit-task-btn" onclick="submitTask()">Submit Task</button>
            </div>
        </div>
    </div>

    <!-- View Submission Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submission Details</h2>
                <button class="close-btn" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Submission details will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            updateDoc,
            deleteDoc,
            doc,
            getDoc,
            getDocs,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyChk2JA68-I5s1D0S10r9WK71LgTNi4hRQ",
            authDomain: "nextgen-5fb6f.firebaseapp.com",
            projectId: "nextgen-5fb6f",
            storageBucket: "nextgen-5fb6f.firebasestorage.app",
            messagingSenderId: "100132076455",
            appId: "1:100132076455:web:c5aea1f6e1a5ebbea99482"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let currentTaskId = null;
        let userBalance = 0;
        let userData = {};

        // Make functions available globally
        window.showSection = showSection;
        window.filterTasks = filterTasks;
        window.openSubmitModal = openSubmitModal;
        window.submitTask = submitTask;
        window.closeModal = closeModal;
        window.closeViewModal = closeViewModal;
        window.viewSubmission = viewSubmission;
        window.requestWithdrawal = requestWithdrawal;
        window.updateProfile = updateProfile;
        window.logout = logout;

        // Show loading overlay
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Show message
        function showMessage(text, type) {
            // Create a temporary message div if it doesn't exist
            let messageDiv = document.getElementById('temporaryMessage');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'temporaryMessage';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.right = '20px';
                messageDiv.style.padding = '15px 20px';
                messageDiv.style.borderRadius = '5px';
                messageDiv.style.zIndex = '9999';
                messageDiv.style.maxWidth = '300px';
                document.body.appendChild(messageDiv);
            }
            
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : 
                                            type === 'error' ? '#f8d7da' : 
                                            type === 'warning' ? '#fff3cd' : '#d1ecf1';
            messageDiv.style.color = type === 'success' ? '#155724' : 
                                    type === 'error' ? '#721c24' : 
                                    type === 'warning' ? '#856404' : '#0c5460';
            messageDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : 
                                    type === 'error' ? '1px solid #f5c6cb' : 
                                    type === 'warning' ? '1px solid #ffeeba' : '1px solid #bee5eb';
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Logout
        async function logout() {
            showLoading(true);
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Error logging out', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Show different sections
        function showSection(section) {
            // Hide all sections
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('tasksSection').style.display = 'none';
            document.getElementById('submissionsSection').style.display = 'none';
            document.getElementById('withdrawalsSection').style.display = 'none';
            document.getElementById('feedbackSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';

            // Remove active class from all menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(section + 'Section').style.display = 'block';

            // Add active class to clicked menu item
            event.target.closest('li').classList.add('active');

            // Load section data
            if (section === 'tasks') {
                loadAvailableTasks();
            } else if (section === 'submissions') {
                loadUserSubmissions();
            } else if (section === 'withdrawals') {
                loadWithdrawalHistory();
            } else if (section === 'feedback') {
                loadUserFeedback();
            }
        }

        // Load dashboard data
        function loadDashboard() {
            if (!currentUser) return;

            // Update welcome name
            document.getElementById('welcomeName').textContent = currentUser.displayName || 'User';
            document.getElementById('userName').textContent = currentUser.displayName || 'User';
            document.getElementById('userAvatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();

            // Load categories
            loadCategories();

            // Load recent tasks
            loadRecentTasks();

            // Load user stats
            loadUserStats();
        }

        // Load categories
        function loadCategories() {
            const categories = [
                { name: 'Data Entry', icon: 'üìä', price: '5-20', count: 15, color: '#667eea' },
                { name: 'Content Writing', icon: '‚úçÔ∏è', price: '10-50', count: 8, color: '#764ba2' },
                { name: 'Testing', icon: 'üß™', price: '15-30', count: 12, color: '#28a745' },
                { name: 'Surveys', icon: 'üìù', price: '2-10', count: 25, color: '#ffc107' },
                { name: 'Design', icon: 'üé®', price: '20-100', count: 6, color: '#17a2b8' },
                { name: 'Social Media', icon: 'üì±', price: '1-5', count: 30, color: '#dc3545' }
            ];

            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = categories.map(cat => `
                <div class="category-card" onclick="showSection('tasks')" style="border-top: 4px solid ${cat.color}">
                    <div class="category-icon">${cat.icon}</div>
                    <h3>${cat.name}</h3>
                    <div class="category-price">$${cat.price}</div>
                    <div class="category-tasks">${cat.count} tasks available</div>
                </div>
            `).join('');

            // Populate category filter
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="all">All Categories</option>' + 
                    categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            }
        }

        // Load recent tasks
        function loadRecentTasks() {
            const tasks = [
                {
                    id: 1,
                    title: 'Data Entry Task',
                    description: 'Enter product information into spreadsheet',
                    price: 15,
                    category: 'Data Entry',
                    deadline: '2024-12-31',
                    status: 'available'
                },
                {
                    id: 2,
                    title: 'Write Product Review',
                    description: 'Write a 500-word review for a new product',
                    price: 25,
                    category: 'Content Writing',
                    deadline: '2024-12-30',
                    status: 'available'
                },
                {
                    id: 3,
                    title: 'Website Testing',
                    description: 'Test website functionality and report bugs',
                    price: 30,
                    category: 'Testing',
                    deadline: '2024-12-29',
                    status: 'available'
                }
            ];

            displayTasks(tasks, 'recentTasks');
        }

        // Load available tasks
        function loadAvailableTasks() {
            const tasks = [
                {
                    id: 1,
                    title: 'Data Entry Task',
                    description: 'Enter product information into spreadsheet',
                    price: 15,
                    category: 'Data Entry',
                    deadline: '2024-12-31',
                    status: 'available'
                },
                {
                    id: 2,
                    title: 'Write Product Review',
                    description: 'Write a 500-word review for a new product',
                    price: 25,
                    category: 'Content Writing',
                    deadline: '2024-12-30',
                    status: 'available'
                },
                {
                    id: 3,
                    title: 'Website Testing',
                    description: 'Test website functionality and report bugs',
                    price: 30,
                    category: 'Testing',
                    deadline: '2024-12-29',
                    status: 'available'
                },
                {
                    id: 4,
                    title: 'Market Survey',
                    description: 'Complete a 10-minute survey about consumer habits',
                    price: 8,
                    category: 'Surveys',
                    deadline: '2024-12-28',
                    status: 'available'
                },
                {
                    id: 5,
                    title: 'Logo Design',
                    description: 'Create a simple logo for a startup',
                    price: 50,
                    category: 'Design',
                    deadline: '2024-12-27',
                    status: 'available'
                },
                {
                    id: 6,
                    title: 'Social Media Engagement',
                    description: 'Like and share 20 posts',
                    price: 5,
                    category: 'Social Media',
                    deadline: '2024-12-26',
                    status: 'available'
                }
            ];

            displayTasks(tasks, 'allTasks');
        }

        // Display tasks
        function displayTasks(tasks, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = tasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-category">${task.category}</span>
                        <span class="task-price">$${task.price}</span>
                    </div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-description">${task.description}</div>
                    <div class="task-deadline">Deadline: ${task.deadline}</div>
                    <div class="task-footer">
                        <span class="task-status status-available">Available</span>
                        <button class="submit-btn" onclick="openSubmitModal(${task.id})">Submit Task</button>
                    </div>
                </div>
            `).join('');
        }

        // Filter tasks
        function filterTasks() {
            const category = document.getElementById('categoryFilter').value;
            const sort = document.getElementById('sortFilter').value;
            
            // Filter and sort tasks based on selection
            loadAvailableTasks();
            showMessage('Tasks filtered!', 'success');
        }

        // Open submit modal
        function openSubmitModal(taskId) {
            currentTaskId = taskId;
            
            // Get task details (in real app, fetch from Firestore)
            const taskDetails = {
                title: 'Sample Task',
                price: 15,
                description: 'Task description here'
            };
            
            document.getElementById('taskDetails').innerHTML = `
                <h3>${taskDetails.title}</h3>
                <p><strong>Reward:</strong> $${taskDetails.price}</p>
                <p>${taskDetails.description}</p>
            `;
            
            document.getElementById('submitModal').classList.add('active');
        }

        // Submit task
        async function submitTask() {
            const work = document.getElementById('submissionWork').value.trim();
            const notes = document.getElementById('submissionNotes').value.trim();

            if (!work) {
                showMessage('Please describe your work', 'error');
                return;
            }

            showLoading(true);

            try {
                // Save submission to Firestore (if available)
                if (db) {
                    await addDoc(collection(db, 'submissions'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        taskId: currentTaskId,
                        work: work,
                        notes: notes,
                        status: 'pending',
                        submittedAt: new Date().toISOString(),
                        adminFeedback: []
                    });
                }

                showMessage('Task submitted successfully!', 'success');
                closeModal();
                
                // Clear form
                document.getElementById('submissionWork').value = '';
                document.getElementById('submissionNotes').value = '';

            } catch (error) {
                console.error('Submission error:', error);
                showMessage('Error submitting task: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('submitModal').classList.remove('active');
            document.getElementById('submissionWork').value = '';
            document.getElementById('submissionNotes').value = '';
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        // Load user submissions
        async function loadUserSubmissions() {
            if (!currentUser) return;

            const submissionsList = document.getElementById('submissionsList');
            submissionsList.innerHTML = '<div class="table-row">Loading submissions...</div>';

            try {
                // Try to get from Firestore first
                let submissions = [];
                
                if (db) {
                    const q = query(
                        collection(db, 'submissions'),
                        where('userId', '==', currentUser.uid),
                        orderBy('submittedAt', 'desc')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach(doc => {
                        submissions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
                
                // If no submissions in Firestore, show sample data
                if (submissions.length === 0) {
                    submissionsList.innerHTML = '<div class="table-row">No submissions yet</div>';
                    return;
                }

                submissionsList.innerHTML = '';
                submissions.forEach(sub => {
                    submissionsList.innerHTML += `
                        <div class="table-row">
                            <div>Task #${sub.taskId}</div>
                            <div>${new Date(sub.submittedAt).toLocaleDateString()}</div>
                            <div>$${sub.reward || 'N/A'}</div>
                            <div><span class="status-badge badge-${sub.status}">${sub.status}</span></div>
                            <div><button class="view-btn" onclick="viewSubmission('${sub.id}')">View</button></div>
                        </div>
                    `;
                });

            } catch (error) {
                console.error('Error loading submissions:', error);
                submissionsList.innerHTML = '<div class="table-row">Error loading submissions</div>';
            }
        }

        // View submission
        async function viewSubmission(submissionId) {
            try {
                let submission = null;
                
                if (db) {
                    const docRef = doc(db, 'submissions', submissionId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        submission = docSnap.data();
                    }
                }
                
                if (!submission) {
                    showMessage('Submission not found', 'error');
                    return;
                }
                
                let feedbackHtml = '';
                if (submission.adminFeedback && submission.adminFeedback.length > 0) {
                    feedbackHtml = submission.adminFeedback.map(f => `
                        <div class="admin-feedback">
                            <strong>Admin:</strong> ${f.message}<br>
                            <small>${new Date(f.timestamp).toLocaleString()}</small>
                        </div>
                    `).join('');
                }

                document.getElementById('viewModalBody').innerHTML = `
                    <h3>Task #${submission.taskId}</h3>
                    <p><strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="status-badge badge-${submission.status}">${submission.status}</span></p>
                    <p><strong>Your Work:</strong></p>
                    <p>${submission.work}</p>
                    ${submission.notes ? `<p><strong>Notes:</strong> ${submission.notes}</p>` : ''}
                    ${submission.review ? `<p><strong>Review:</strong> ${submission.review}</p>` : ''}
                    <div class="feedback-section">
                        <h4>Feedback</h4>
                        ${feedbackHtml || 'No feedback yet'}
                    </div>
                `;

                document.getElementById('viewModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading submission:', error);
                showMessage('Error loading submission', 'error');
            }
        }

        // Request withdrawal
        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const details = document.getElementById('accountDetails').value.trim();

            if (!amount || amount < 10) {
                showMessage('Minimum withdrawal amount is $10', 'error');
                return;
            }

            if (!details) {
                showMessage('Please enter your account details', 'error');
                return;
            }

            showLoading(true);

            try {
                if (db) {
                    await addDoc(collection(db, 'withdrawals'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        amount: amount,
                        method: method,
                        accountDetails: details,
                        status: 'pending',
                        requestedAt: new Date().toISOString()
                    });
                }

                showMessage('Withdrawal request submitted!', 'success');
                
                // Clear form
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('accountDetails').value = '';

                // Refresh withdrawal history
                loadWithdrawalHistory();

            } catch (error) {
                console.error('Withdrawal error:', error);
                showMessage('Error requesting withdrawal: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load withdrawal history
        async function loadWithdrawalHistory() {
            if (!currentUser) return;

            const historyDiv = document.getElementById('withdrawalHistory');

            try {
                let withdrawals = [];
                
                if (db) {
                    const q = query(
                        collection(db, 'withdrawals'),
                        where('userId', '==', currentUser.uid),
                        orderBy('requestedAt', 'desc')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach(doc => {
                        withdrawals.push(doc.data());
                    });
                }
                
                if (withdrawals.length === 0) {
                    historyDiv.innerHTML = '<p>No withdrawal history</p>';
                    return;
                }

                historyDiv.innerHTML = '';
                withdrawals.forEach(w => {
                    historyDiv.innerHTML += `
                        <div class="withdrawal-item">
                            <div>
                                <div class="withdrawal-amount">$${w.amount}</div>
                                <div class="withdrawal-method">${w.method}</div>
                                <div class="withdrawal-date">${new Date(w.requestedAt).toLocaleDateString()}</div>
                            </div>
                            <div><span class="status-badge badge-${w.status}">${w.status}</span></div>
                        </div>
                    `;
                });

            } catch (error) {
                console.error('Error loading withdrawals:', error);
                historyDiv.innerHTML = '<p>Error loading withdrawal history</p>';
            }
        }

        // Load user feedback
        async function loadUserFeedback() {
            if (!currentUser) return;

            const feedbackDiv = document.getElementById('feedbackList');
            feedbackDiv.innerHTML = '<p>Loading feedback...</p>';

            try {
                let feedbacks = [];
                
                if (db) {
                    const q = query(
                        collection(db, 'feedback'),
                        where('userId', '==', currentUser.uid),
                        orderBy('createdAt', 'desc')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach(doc => {
                        feedbacks.push(doc.data());
                    });
                }
                
                if (feedbacks.length === 0) {
                    feedbackDiv.innerHTML = '<p>No feedback yet</p>';
                    return;
                }

                feedbackDiv.innerHTML = '';
                feedbacks.forEach(f => {
                    feedbackDiv.innerHTML += `
                        <div class="feedback-item">
                            <div class="feedback-header">
                                <span>Task #${f.taskId}</span>
                                <span>${new Date(f.createdAt).toLocaleDateString()}</span>
                            </div>
                            <div class="feedback-text">${f.message}</div>
                            ${f.adminResponse ? `
                                <div class="admin-feedback">
                                    <strong>Admin Response:</strong> ${f.adminResponse}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

            } catch (error) {
                console.error('Error loading feedback:', error);
                feedbackDiv.innerHTML = '<p>Error loading feedback</p>';
            }
        }

        // Load user stats
        async function loadUserStats() {
            if (!currentUser) return;

            try {
                // Set default values
                document.getElementById('balance').textContent = '$0.00';
                document.getElementById('totalEarnings').textContent = '$0';
                document.getElementById('availableBalance').textContent = '$0';
                document.getElementById('tasksCompleted').textContent = '0';
                document.getElementById('pendingTasks').textContent = '0';

                if (db) {
                    // Get user balance from Firestore
                    const userRef = doc(db, 'users', currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        userData = userSnap.data();
                        userBalance = userData.balance || 0;
                        
                        document.getElementById('balance').textContent = `$${userBalance.toFixed(2)}`;
                        document.getElementById('totalEarnings').textContent = `$${userData.totalEarnings || 0}`;
                        document.getElementById('availableBalance').textContent = `$${userBalance.toFixed(2)}`;
                    }

                    // Count submissions
                    const submissionsQuery = query(
                        collection(db, 'submissions'),
                        where('userId', '==', currentUser.uid)
                    );
                    const submissionsSnap = await getDocs(submissionsQuery);
                    
                    let completed = 0;
                    let pending = 0;
                    
                    submissionsSnap.forEach(doc => {
                        const status = doc.data().status;
                        if (status === 'approved') completed++;
                        else if (status === 'pending') pending++;
                    });

                    document.getElementById('tasksCompleted').textContent = completed;
                    document.getElementById('pendingTasks').textContent = pending;
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Update profile
        async function updateProfile() {
            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            const paypal = document.getElementById('profilePaypal').value;
            const bank = document.getElementById('profileBank').value;

            showLoading(true);

            try {
                if (db) {
                    const userRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userRef, {
                        displayName: name,
                        phone: phone,
                        paypalEmail: paypal,
                        bankDetails: bank,
                        updatedAt: new Date().toISOString()
                    });
                }

                showMessage('Profile updated successfully!', 'success');
            } catch (error) {
                console.error('Profile update error:', error);
                showMessage('Error updating profile: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load profile data
        async function loadProfile() {
            if (!currentUser) return;

            document.getElementById('profileName').value = currentUser.displayName || '';
            document.getElementById('profileEmail').value = currentUser.email || '';

            try {
                if (db) {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const data = userSnap.data();
                        document.getElementById('profilePhone').value = data.phone || '';
                        document.getElementById('profilePaypal').value = data.paypalEmail || '';
                        document.getElementById('profileBank').value = data.bankDetails || '';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                currentUser = user;
                loadDashboard();
                loadProfile();
            } else if (user && !user.emailVerified) {
                window.location.href = 'login.html?verify=' + encodeURIComponent(user.email);
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>